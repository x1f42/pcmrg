/* replay gain!? */

#include <fcntl.h>
#include <math.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define M21(A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U) \
    (d[-1] * A - p[-1] * B + d[-2] * C - p[-2] * D + d[-3] * E - p[-3] * F    \
     + d[-4] * G - p[-4] * H + d[-5] * I - p[-5] * J + d[-6] * K - p[-6] * L  \
     + d[-7] * M - p[-7] * N + d[-8] * O - p[-8] * P + d[-9] * Q - p[-9] * R  \
     + d[-10] * S - p[-10] * T + d[-11] * U)

#define M5(A, B, C, D, E) \
    (d[-1] * A - p[-1] * B + d[-2] * C - p[-2] * D + d[-3] * E)

void
f2205(double *d, double *p)
{
    d += 11;
    p += 10;
    *p = M21(.33642304856132, -1.49858979367799, -.25572241425570, .87350271418188, -.11828570177555, .12205022308084, .11921148675203, -.80774944671438, -.07834489609479, .47854794562326, -.00469977914380, -.12453458140019, -.00589500224440, -.04067510197014, .05724228140351, .08333755284107, .00832043980773, -.04237348025746, -.01635381384540, .02977207319925, -.01760176568150);
    d -= 11;
    memmove(d, d + 1, sizeof(double) * 10);
}


void
f441(double *d, double *p)
{
    d += 11;
    p += 10;
    *p =
	(d[-1] * .05418656406430
	 - p[-1] * -3.47845948550071
	 + d[-2] * -.02911007808948
	 - p[-2] * 6.36317777566148
	 + d[-3] * -.00848709379851
	 - p[-3] * -8.54751527471874
	 + d[-4] * -.00851165645469
	 - p[-4] * 9.47693607801280
	 + d[-5] * -.00834990904936
	 - p[-5] * -8.81498681370155
	 + d[-6] * .02245293253339
	 - p[-6] * 6.85401540936998
	 + d[-7] * -.02596338512915
	 - p[-7] * -4.39470996079559
	 + d[-8] * .01624864962975
	 - p[-8] * 2.19611684890774
	 + d[-9] * -.00240879051584
	 - p[-9] * -.75104302451432
	 + d[-10] * .00674613682247
	 - p[-10] * .13149317958808
	 + d[-11] * -.00187763777362);
    d -= 11;
    memmove(d, d + 1, sizeof(double) * 10);
}


void
f480(double *d, double *p)
{
    d += 11;
    p += 10;
    *p =
	(d[-1] * .03857599435200
	 - p[-1] * -3.84664617118067
	 + d[-2] * -.02160367184185
	 - p[-2] * 7.81501653005538
	 + d[-3] * -.00123395316851
	 - p[-3] * -11.34170355132042
	 + d[-4] * -.00009291677959
	 - p[-4] * 13.05504219327545
	 + d[-5] * -.01655260341619
	 - p[-5] * -12.28759895145294
	 + d[-6] * .02161526843274
	 - p[-6] * 9.48293806319790
	 + d[-7] * -.02074045215285
	 - p[-7] * -5.87257861775999
	 + d[-8] * .00594298065125
	 - p[-8] * 2.75465861874613
	 + d[-9] * .00306428023191 
	 - p[-9] * -.86984376593551
	 + d[-10] * .00012025322027
	 - p[-10] * .13919314567432
	 + d[-11] * .00288463683916);
    d -= 11;
    memmove(d, d + 1, sizeof(double) * 10);
}


void
s2205(double *d, double *p)
{
    d += 11;
    p += 10;
    *p = M5(.97316523498161, -1.94561023566527, -1.94633046996323, .94705070426118, .97316523498161);
    d -= 11;
    memmove(d, d + 1, sizeof(double) * 10);
}


void
s441(double *d, double *p)
{
    d += 11;
    p += 10;
    *p =
	(d[-1] * .98500175787242
	 - p[-1] * -1.96977855582618
	 + d[-2] * -1.97000351574484
	 - p[-2] * .97022847566350
	 + d[-3] * .98500175787242);
    d -= 11;
    memmove(d, d + 1, sizeof(double) * 10);
}


void
s480(double *d, double *p)
{
    d += 11;
    p += 10;
    *p =
	(d[-1] * .98621192462708
	 - p[-1] * -1.97223372919527
	 + d[-2] * -1.97242384925416
	 - p[-2] * .97261396931306
	 + d[-3] * .98621192462708);
    d -= 11;
    memmove(d, d + 1, sizeof(double) * 10);
}


int
main(int argc, char **argv)
{
    double l0[11], l1[11], l2[11], m = 0, r0[11], r1[11], r2[11];
    int cc, fd, fq, fs, i, x[12000], xw = 0;
    void (*f0)(double *, double *), (*f1)(double *, double *), *kg;

    if (argc != 4) {
	exit(1);
    }

    fd = open(argv[1], O_RDONLY);
    if (fd == -1) {
	exit(1);
    }

    kg = malloc(1 << 18);
    if (!kg) {
	exit(1);
    }

    for (i = 0; i < 10; i++) {
	l0[i] = l1[i] = l2[i] = r0[i] = r1[i] = r2[i] = 0;
    }

    switch (argv[2][0]) {
    case 'A':
	f0 = f441;
	f1 = s441;
	fq = 44100;
	break;
    case 'B':
	f0 = f480;
	f1 = s480;
	fq = 48000;
	break;
    default:
	f0 = f2205;
	f1 = s2205;
	fq = 22050;
    }

    memset(x, 0, 12000 * sizeof(int));

    cc = fq / 20;

    if (argv[3][0] == '1') {
	while (0 < (fs = read(fd, kg, 1 << 18))) {
	    int j;
	    unsigned char *l;

	    l = kg;
	    j = fs >> 1;
	    for (; j; j--) {
		double v;

		v = *l++;
		v += *l++ << 8;
		if (32767 < v) {
		    v -= 65536;
		}

		l0[10] = v;
		f0(l0, l1);
		f1(l1, l2);

		m += l2[0] * l2[0];

		memmove(l2, l2 + 1, sizeof(double) * 10);

		cc -= 1;
		if (cc) {
		} else {
		    int w;

		    cc = fq / 20;
    //debug("%d %f", cc, m);
		    w = 100 * 10 * log10(m / cc / 1 + 1e-37);
		    m = 0;

		    if (w < 0) {
			w = 0;
		    } else {
			if (11999 < w) {
			    w = 11999;
			} else {
			}
		    }

		    xw++;
		    x[w]++;
		}
	    }
	}
    } else {
	while (0 < (fs = read(fd, kg, 1 << 18))) {
	    int j;
	    unsigned char *l;

	    l = kg;
	    j = fs >> 2;
	    for (; j; j--) {
		double v;

		v = *l++;
		v += *l++ << 8;
		if (32767 < v) {
		    v -= 65536;
		}

		l0[10] = v;
		f0(l0, l1);
		f1(l1, l2);

		v = *l++;
		v += *l++ << 8;
		if (32767 < v) {
		    v -= 65536;
		}

		r0[10] = v;
		f0(r0, r1);
		f1(r1, r2);

		m += l2[0] * l2[0];
		m += r2[0] * r2[0];

		memmove(l2, l2 + 1, sizeof(double) * 10);
		memmove(r2, r2 + 1, sizeof(double) * 10);

		cc -= 1;
		if (cc) {
		} else {
		    int w;

		    cc = fq / 20;
    //debug("%d %f", cc, m);
		    w = 100 * 10 * log10(m / cc / 2 + 1e-37);
		    m = 0;

		    if (w < 0) {
			w = 0;
		    } else {
			if (11999 < w) {
			    w = 11999;
			} else {
			}
		    }

		    xw++;
		    x[w]++;
		}
	    }
	}
    }

    free(kg);

    close(fd);
//debug("%d", xw);

    cc = xw / 20;
    i = 11999;
    for (; i; i--) {
	cc -= x[i];
	if (cc < 0) {
	    break;
	}
    }

    printf("%d\n", i);

    return 0;
}
